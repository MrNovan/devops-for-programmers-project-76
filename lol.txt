---
- name: Подготовка серверов (установка Docker и pip)
  hosts: all
  become: yes
  vars:
    pip_install_packages:
      - name: docker

    # Переменные для роли geerlingguy.docker
    docker_apt_source_signed_by: "/etc/apt/keyrings/docker.asc"
    docker_edition: ce
    docker_install_compose: true

  pre_tasks:
    - name: Удаление старого файла репозитория Docker
      ansible.builtin.file:
        path: /etc/apt/sources.list.d/docker.list
        state: absent

    - name: Удаление старого ключа Docker
      ansible.builtin.file:
        path: /usr/share/keyrings/docker-archive-keyring.gpg
        state: absent

  roles:
    - role: geerlingguy.pip
    - role: geerlingguy.docker


- name: Деплой Redmine на серверы
  hosts: all
  become: yes
  vars:
    redmine_env_file: /opt/redmine/.env
    redmine_data_dir: /opt/redmine/data

  pre_tasks:
    - name: Отладка — текущий каталог
      command: pwd
      register: current_dir

    - name: Вывести текущий каталог
      debug:
        msg: "Текущая директория: {{ current_dir.stdout }}"

    - name: Создание директории для данных и env-файла
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - "{{ redmine_data_dir }}"
        - "/opt/redmine"

    - name: Отладка — поиск шаблона .env
      slurp:
        src: templates/redmine.env.j2
      register: env_template
      ignore_errors: yes

    - name: Вывести ошибку, если шаблон не найден
      debug:
        msg: "Шаблон templates/redmine.env.j2 НЕ найден!"
      when: env_template.failed

    - name: Размещение .env файла из шаблона
      ansible.builtin.template:
        src: templates/redmine.env.j2
        dest: ".env"
        mode: '0644'

    - name: Проверка наличия .env файла
      stat:
        path: "{{ redmine_env_file }}"
      register: env_file_stat

    - name: Сообщить, если файл НЕ найден
      debug:
        msg: "Файл {{ redmine_env_file }} НЕ существует!"
      when: not env_file_stat.stat.exists

  tasks:
    - name: Убедиться, что контейнер Redmine остановлен (если существует)
      community.docker.docker_container:
        name: redmine
        image: redmine
        state: stopped
        force_kill: yes

    - name: Удалить предыдущий контейнер Redmine (если есть)
      community.docker.docker_container:
        name: redmine
        image: redmine
        state: absent

    - name: Запустить новый контейнер с Redmine
      community.docker.docker_container:
        name: redmine
        image: redmine
        ports:
          - "{{ redmine_port }}:3000"
        volumes:
          - "{{ redmine_data_dir }}:/usr/src/redmine/public/plugin_assets"
        env_file:
          - "{{ redmine_env_file }}"
        restart_policy: unless-stopped
        state: started